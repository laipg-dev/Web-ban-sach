<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gi·ªè h√†ng | Bookshop</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <!-- Header -->
    <header>
      <h1><a href="index.html" class="back-btn">üè† Trang ch·ªß</a></h1>
      <nav>
        <div class="header-left">
          <a href="profile.html" class="account-btn" id="account-btn">
            üë§ <span id="account-name">T√†i kho·∫£n</span>
          </a>
          <a href="cart.html" class="cart-btn"
            >üõí Gi·ªè h√†ng <span id="cart-count">0</span></a
          >
        </div>
      </nav>
    </header>

    <!-- SECTION 1: Gi·ªè h√†ng -->
    <div id="cart-section" class="page-section active">
      <div class="cart-page">
        <!-- Title -->
        <h2 class="title-cart">
          GI·ªé H√ÄNG <span id="cart-count-text" class="muted"></span>
        </h2>

        <!-- Body -->
        <main class="page grid">
          <!-- Left -->
          <div>
            <div class="card">
              <!-- header columns -->
              <div class="thead">
                <div class="check">
                  <input type="checkbox" id="select-all" class="check" />
                </div>
                <div>
                  <span
                    >Ch·ªçn t·∫•t c·∫£ (<span id="select-all-count">0</span> s·∫£n
                    ph·∫©m)</span
                  >
                </div>
                <div class="th-3">S·ªë l∆∞·ª£ng</div>
                <div class="th-4">Th√†nh ti·ªÅn</div>
                <div></div>
              </div>

              <!-- Cart items -->
              <div id="cart-list"></div>

              <!-- Empty state -->
              <div id="empty-msg" class="empty-msg">
                <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</p>
                <a href="index.html" class="btn">Ti·∫øp t·ª•c mua s·∫Øm</a>
              </div>
            </div>
          </div>

          <!-- Right -->
          <aside>
            <div class="card">
              <div class="summary">
                <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>
                <div class="summary-row">
                  <span>T·∫°m t√≠nh:</span>
                  <span id="subtotal">0‚Ç´</span>
                </div>
                <div class="summary-row">
                  <span>Gi·∫£m gi√°:</span>
                  <span id="discount">0‚Ç´</span>
                </div>
                <hr />
                <div class="summary-row total">
                  <strong>T·ªïng c·ªông:</strong>
                  <strong id="total">0‚Ç´</strong>
                </div>
                <button
                  id="checkout-btn"
                  class="btn checkout-btn"
                  disabled
                >
                  Ti·∫øn h√†nh thanh to√°n
                </button>
              </div>
            </div>
          </aside>
        </main>
      </div>
    </div>

    <!-- SECTION 2: Thanh to√°n -->
    <div id="checkout-section" class="page-section">
      <div class="checkout-container">
        <!-- Left Column -->
        <div class="checkout-left">
          <!-- Order Items -->
          <div class="checkout-section">
            <h2 class="section-title">üì¶ S·∫£n ph·∫©m ƒë√£ ch·ªçn</h2>
            <div id="order-items"></div>
          </div>

          <!-- Delivery Address -->
          <div class="checkout-section">
            <h2 class="section-title">üìç ƒê·ªãa ch·ªâ giao h√†ng</h2>
            <div id="address-list"></div>
            <button class="add-address-btn" id="add-address-btn">
              ‚ûï Th√™m ƒë·ªãa ch·ªâ m·ªõi
            </button>
          </div>

          <!-- Payment Method -->
          <div class="checkout-section">
            <h2 class="section-title">üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h2>

            <div class="payment-method" data-method="cod">
              <input type="radio" name="payment" value="cod" id="payment-cod" checked />
              <div class="payment-icon cod-icon">üöö</div>
              <div class="payment-info">
                <label for="payment-cod">
                  <strong>Thanh to√°n khi nh·∫≠n h√†ng (COD)</strong>
                </label>
                <p class="payment-desc">
                  Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng
                </p>
              </div>
            </div>

            <div class="payment-method" data-method="bank">
              <input type="radio" name="payment" value="bank" id="payment-bank" />
              <div class="payment-icon bank-icon">üè¶</div>
              <div class="payment-info">
                <label for="payment-bank">
                  <strong>Chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong>
                </label>
                <p class="payment-desc">
                  Chuy·ªÉn kho·∫£n qua t√†i kho·∫£n ng√¢n h√†ng
                </p>
              </div>
            </div>

            <div class="payment-method" data-method="momo">
              <input type="radio" name="payment" value="momo" id="payment-momo" />
              <div class="payment-icon momo-icon">üì±</div>
              <div class="payment-info">
                <label for="payment-momo">
                  <strong>V√≠ MoMo</strong>
                </label>
                <p class="payment-desc">Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ MoMo</p>
              </div>
            </div>
          </div>

          <!-- Order Note -->
          <div class="checkout-section">
            <h2 class="section-title">üìù Ghi ch√∫ ƒë∆°n h√†ng</h2>
            <textarea
              id="order-note"
              class="order-note-input"
              placeholder="Nh·∫≠p ghi ch√∫ cho ƒë∆°n h√†ng (t√πy ch·ªçn)..."
              rows="4"
            ></textarea>
          </div>
        </div>

        <!-- Right Column: Order Summary -->
        <div class="checkout-right">
          <div class="order-summary">
            <h2 class="summary-title">üí∞ T·ªïng ƒë∆°n h√†ng</h2>

            <div class="summary-row">
              <span>T·∫°m t√≠nh:</span>
              <span id="checkout-subtotal">0‚Ç´</span>
            </div>

            <div class="summary-row">
              <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
              <span id="shipping-fee">30,000‚Ç´</span>
            </div>

            <div class="summary-row">
              <span>Gi·∫£m gi√°:</span>
              <span id="checkout-discount" class="discount-amount"
                >-0‚Ç´</span
              >
            </div>

            <hr class="summary-divider" />

            <div class="summary-row total-row">
              <strong>T·ªïng c·ªông:</strong>
              <strong id="checkout-total" class="total-amount">0‚Ç´</strong>
            </div>

            <button id="place-order-btn" class="place-order-btn">
              üõçÔ∏è ƒê·∫∑t h√†ng
            </button>

            <div class="checkout-policy">
              <p>
                ‚úÖ B·∫±ng vi·ªác ƒë·∫∑t h√†ng, b·∫°n ƒë·ªìng √Ω v·ªõi
                <a href="#">ƒêi·ªÅu kho·∫£n s·ª≠ d·ª•ng</a> c·ªßa ch√∫ng t√¥i
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTION 3: ƒê∆°n h√†ng th√†nh c√¥ng -->
    <div id="success-section" class="page-section">
      <div class="success-container">
        <div class="success-icon">‚úì</div>
        <h1 class="success-title">ƒê·∫∑t h√†ng th√†nh c√¥ng!</h1>
        <p class="success-message">
          C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng. ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n.
        </p>

        <div class="order-info">
          <div class="info-row">
            <span class="info-label">M√£ ƒë∆°n h√†ng:</span>
            <strong id="order-id"></strong>
          </div>
          <div class="info-row">
            <span class="info-label">T·ªïng ti·ªÅn:</span>
            <strong id="order-total"></strong>
          </div>
          <div class="info-row">
            <span class="info-label">Ph∆∞∆°ng th·ª©c thanh to√°n:</span>
            <span id="order-payment"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Th·ªùi gian ƒë·∫∑t:</span>
            <span id="order-time"></span>
          </div>
        </div>

        <div class="order-items-preview">
          <h3>S·∫£n ph·∫©m ƒë√£ ƒë·∫∑t</h3>
          <div id="order-items-list"></div>
        </div>

        <div class="success-actions">
          <a href="index.html" class="btn btn-primary">Ti·∫øp t·ª•c mua s·∫Øm</a>
          <a href="profile.html" class="btn btn-secondary">Xem ƒë∆°n h√†ng</a>
        </div>
      </div>
    </div>

    <!-- Modal: Th√™m ƒë·ªãa ch·ªâ m·ªõi -->
    <div id="address-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>‚ûï Th√™m ƒë·ªãa ch·ªâ giao h√†ng m·ªõi</h3>
          <button class="modal-close" id="close-address-modal">&times;</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="new-name">H·ªç v√† t√™n</label>
            <input
              type="text"
              id="new-name"
              class="form-control"
              placeholder="Nh·∫≠p h·ªç v√† t√™n"
            />
          </div>

          <div class="form-group">
            <label for="new-phone">S·ªë ƒëi·ªán tho·∫°i</label>
            <input
              type="tel"
              id="new-phone"
              class="form-control"
              placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
            />
          </div>

          <div class="form-group">
            <label for="new-address">ƒê·ªãa ch·ªâ chi ti·∫øt</label>
            <textarea
              id="new-address"
              class="form-control"
              rows="3"
              placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng, ph∆∞·ªùng/x√£, qu·∫≠n/huy·ªán, t·ªânh/th√†nh ph·ªë"
            ></textarea>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="set-default" />
              ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" id="cancel-address">H·ªßy</button>
          <button class="btn btn-primary" id="save-address">L∆∞u</button>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <p>¬© 2025 Web B√°n S√°ch. T·∫•t c·∫£ c√°c quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
    </footer>

    <script src="cart.js"></script>
    <script src="checkout.js"></script>
    <script src="order-success.js"></script>
    <script>
      // ===== NAVIGATION SYSTEM =====
      function showSection(sectionId) {
        document.querySelectorAll('.page-section').forEach(section => {
          section.classList.remove('active');
        });
        
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.classList.add('active');
          window.scrollTo(0, 0);
        }
      }

      // M·∫∑c ƒë·ªãnh hi·ªán gi·ªè h√†ng
      document.addEventListener('DOMContentLoaded', () => {
        showSection('cart-section');
        
        // N√∫t thanh to√°n
        const checkoutBtn = document.getElementById('checkout-btn');
        if (checkoutBtn) {
          checkoutBtn.addEventListener('click', () => {
            loadCheckoutInfo();
            showSection('checkout-section');
          });
        }

        // N√∫t ƒë·∫∑t h√†ng
        const placeOrderBtn = document.getElementById('place-order-btn');
        if (placeOrderBtn) {
          placeOrderBtn.addEventListener('click', () => {
            const orderId = processOrder();
            
            if (orderId) {
              displayOrderSuccess(orderId);
              showSection('success-section');
            }
          });
        }

        // Modal th√™m ƒë·ªãa ch·ªâ
        const addAddressBtn = document.getElementById('add-address-btn');
        if (addAddressBtn) {
          addAddressBtn.addEventListener('click', () => {
            document.getElementById('address-modal').classList.add('active');
          });
        }

        const closeModal = document.getElementById('close-address-modal');
        if (closeModal) {
          closeModal.addEventListener('click', () => {
            document.getElementById('address-modal').classList.remove('active');
          });
        }

        const cancelAddress = document.getElementById('cancel-address');
        if (cancelAddress) {
          cancelAddress.addEventListener('click', () => {
            document.getElementById('address-modal').classList.remove('active');
          });
        }

        const saveAddress = document.getElementById('save-address');
        if (saveAddress) {
          saveAddress.addEventListener('click', () => {
            saveNewAddress();
            document.getElementById('address-modal').classList.remove('active');
          });
        }
      });

      // ===== CHECKOUT FUNCTIONS =====
      function loadCheckoutInfo() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) {
          alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
          window.location.href = 'index.html';
          return;
        }

        const cartKey = 'cart_user' + user.id;
        const cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
        const selectedItems = cart.filter(item => item.selected !== false);

        if (selectedItems.length === 0) {
          alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n!');
          showSection('cart-section');
          return;
        }

        const books = JSON.parse(localStorage.getItem('BOOKS') || '[]');
        const orderItems = document.getElementById('order-items');
        let subtotal = 0;

        orderItems.innerHTML = selectedItems.map(item => {
          const book = books.find(b => b.id == item.bookId);
          const total = (book?.price || 0) * item.quantity;
          subtotal += total;
          
          return `
            <div class="checkout-item">
              <img src="${book?.image_url || ''}" alt="${book?.title || ''}">
              <div class="item-info">
                <h4>${book?.title || ''}</h4>
                <p>S·ªë l∆∞·ª£ng: ${item.quantity}</p>
              </div>
              <div class="item-price">${total.toLocaleString('vi-VN')} ƒë</div>
            </div>
          `;
        }).join('');

        // Load ƒë·ªãa ch·ªâ
        loadAddresses(user.id);

        // T√≠nh t·ªïng
        const shippingFee = 30000;
        const total = subtotal + shippingFee;

        document.getElementById('checkout-subtotal').textContent = subtotal.toLocaleString('vi-VN') + ' ƒë';
        document.getElementById('shipping-fee').textContent = shippingFee.toLocaleString('vi-VN') + ' ƒë';
        document.getElementById('checkout-total').textContent = total.toLocaleString('vi-VN') + ' ƒë';
      }

      function loadAddresses(userId) {
        const addressKey = 'addresses_' + userId;
        const addresses = JSON.parse(localStorage.getItem(addressKey) || '[]');
        const addressList = document.getElementById('address-list');

        if (addresses.length === 0) {
          addressList.innerHTML = '<p>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o. Vui l√≤ng th√™m ƒë·ªãa ch·ªâ m·ªõi.</p>';
          return;
        }

        addressList.innerHTML = addresses.map((addr, index) => `
          <div class="address-card ${index === 0 ? 'selected' : ''}" data-id="${addr.id}">
            <input type="radio" name="address" value="${addr.id}" ${index === 0 ? 'checked' : ''}>
            <div>
              <strong>${addr.name}</strong> | ${addr.phone}
              ${addr.isDefault ? '<span class="badge">M·∫∑c ƒë·ªãnh</span>' : ''}
              <br>${addr.street}, ${addr.ward}, ${addr.district}, ${addr.city}
            </div>
          </div>
        `).join('');

        // Click v√†o card ƒë·ªÉ ch·ªçn
        document.querySelectorAll('.address-card').forEach(card => {
          card.addEventListener('click', function() {
            document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input[type="radio"]').checked = true;
          });
        });
      }

      function saveNewAddress() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) return;

        const name = document.getElementById('new-name').value.trim();
        const phone = document.getElementById('new-phone').value.trim();
        const address = document.getElementById('new-address').value.trim();
        const isDefault = document.getElementById('set-default').checked;

        if (!name || !phone || !address) {
          alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
          return;
        }

        const addressKey = 'addresses_' + user.id;
        let addresses = JSON.parse(localStorage.getItem(addressKey) || '[]');

        if (isDefault) {
          addresses.forEach(addr => addr.isDefault = false);
        }

        const newAddress = {
          id: Date.now(),
          name,
          phone,
          street: address,
          ward: '',
          district: '',
          city: '',
          isDefault
        };

        addresses.unshift(newAddress);
        localStorage.setItem(addressKey, JSON.stringify(addresses));

        // Clear form
        document.getElementById('new-name').value = '';
        document.getElementById('new-phone').value = '';
        document.getElementById('new-address').value = '';
        document.getElementById('set-default').checked = false;

        loadAddresses(user.id);
      }

      function processOrder() {
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user) return null;

        const selectedAddress = document.querySelector('input[name="address"]:checked');
        if (!selectedAddress) {
          alert('Vui l√≤ng ch·ªçn ƒë·ªãa ch·ªâ giao h√†ng!');
          return null;
        }

        const paymentMethod = document.querySelector('input[name="payment"]:checked')?.value || 'cod';
        const note = document.getElementById('order-note').value.trim();

        const cartKey = 'cart_user' + user.id;
        const cart = JSON.parse(localStorage.getItem(cartKey) || '[]');
        const selectedItems = cart.filter(item => item.selected !== false);

        const books = JSON.parse(localStorage.getItem('BOOKS') || '[]');
        let total = 0;

        const orderDetails = selectedItems.map(item => {
          const book = books.find(b => b.id == item.bookId);
          const subtotal = (book?.price || 0) * item.quantity;
          total += subtotal;
          return {
            bookId: item.bookId,
            quantity: item.quantity,
            price: book?.price || 0,
            subtotal
          };
        });

        total += 30000; // Shipping fee

        const orderId = 'ORD' + Date.now();
        const order = {
          id: orderId,
          userId: user.id,
          addressId: selectedAddress.value,
          paymentMethod,
          note,
          items: orderDetails,
          total,
          status: 'pending',
          created_at: new Date().toISOString()
        };

        // Save order
        let orders = JSON.parse(localStorage.getItem('orders') || '[]');
        orders.push(order);
        localStorage.setItem('orders', JSON.stringify(orders));

        // Clear selected items from cart
        const remainingCart = cart.filter(item => item.selected === false);
        localStorage.setItem(cartKey, JSON.stringify(remainingCart));

        return orderId;
      }

      function displayOrderSuccess(orderId) {
        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
        const order = orders.find(o => o.id === orderId);
        
        if (!order) return;

        document.getElementById('order-id').textContent = orderId;
        document.getElementById('order-total').textContent = order.total.toLocaleString('vi-VN') + ' ƒë';
        
        const paymentNames = {
          'cod': 'Thanh to√°n khi nh·∫≠n h√†ng',
          'bank': 'Chuy·ªÉn kho·∫£n ng√¢n h√†ng',
          'momo': 'V√≠ MoMo'
        };
        document.getElementById('order-payment').textContent = paymentNames[order.paymentMethod] || 'COD';
        document.getElementById('order-time').textContent = new Date(order.created_at).toLocaleString('vi-VN');

        const books = JSON.parse(localStorage.getItem('BOOKS') || '[]');
        const itemsList = document.getElementById('order-items-list');
        
        itemsList.innerHTML = order.items.map(item => {
          const book = books.find(b => b.id == item.bookId);
          return `
            <div class="success-item">
              <img src="${book?.image_url || ''}" alt="${book?.title || ''}">
              <div>
                <strong>${book?.title || ''}</strong>
                <p>S·ªë l∆∞·ª£ng: ${item.quantity} √ó ${item.price.toLocaleString('vi-VN')} ƒë</p>
              </div>
            </div>
          `;
        }).join('');
      }
    </script>
  </body>
</html>
